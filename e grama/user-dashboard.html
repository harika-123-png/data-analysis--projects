<!-- user-dashboard.html -->
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>User - Digital E Gram Panchayat</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div class="header">
    <h2>User Panel</h2>
    <div><button id="btnLogout">Logout</button></div>
  </div>

  <div class="container">
    <div class="card">
      <h3>Available Services</h3>
      <input id="searchBox" placeholder="Search services by title" style="margin-bottom:10px;padding:8px;width:100%">
      <div id="serviceGrid" class="services-grid"></div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3>My Applications</h3>
      <table class="table" id="myApps">
        <thead><tr><th>ID</th><th>Service</th><th>Status</th><th>Applied</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script type="module">
    import { authInit, logout, getCurrentUser } from './js/auth.js';
    import { listenServices, renderServiceCard } from './js/services.js';
    import { applyToService, listenMyApplications } from './js/applications.js';

    authInit('user'); // ensure role

    document.getElementById('btnLogout').onclick = ()=>logout();

    // services
    listenServices((services) => {
      const grid = document.getElementById('serviceGrid');
      grid.innerHTML='';
      services.forEach(s => grid.appendChild(renderServiceCard(s, { showApply: true })));
    });

    document.getElementById('serviceGrid').addEventListener('click', async (e) => {
      if(e.target.dataset.action === 'apply') {
        const id = e.target.dataset.id;
        const serviceTitle = e.target.dataset.title;
        const user = await getCurrentUser();
        // simple prompt for additional data (in real app use a form)
        const details = prompt(`Apply for "${serviceTitle}". Enter details (address/phone/etc):`);
        if(details) {
          await applyToService({ serviceId: id, data: { details } });
          alert('Application submitted');
        }
      }
    });

    // my apps
    listenMyApplications((apps) => {
      const tbody = document.querySelector('#myApps tbody');
      tbody.innerHTML='';
      apps.forEach(a => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${a.id}</td><td>${a.serviceTitle}</td><td>${a.status}</td><td>${new Date(a.appliedAt?.toDate?.() || a.appliedAt || Date.now()).toLocaleString()}</td>`;
        tbody.appendChild(tr);
      });
    });

    // search
    document.getElementById('searchBox').addEventListener('input', (e) => {
      const q = e.target.value.toLowerCase();
      document.querySelectorAll('.service').forEach(card => {
        const title = card.dataset.title.toLowerCase();
        card.style.display = title.includes(q) ? '' : 'none';
      });
    });
  </script>
</body>
</html>
